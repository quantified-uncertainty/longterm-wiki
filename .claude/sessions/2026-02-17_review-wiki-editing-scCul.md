## 2026-02-17 | claude/review-wiki-editing-scCul | Wiki editing system refactoring

**What was done:** Six refactors to the wiki editing pipeline: (1) extracted shared regex patterns to `crux/lib/patterns.ts`, (2) refactored validation in page-improver to use in-process engine calls instead of subprocess spawning, (3) split the 694-line `phases.ts` into 7 individual phase modules under `phases/`, (4) created shared LLM abstraction `crux/lib/llm.ts` unifying duplicated streaming/retry/tool-loop code, (5) added Zod schemas for LLM JSON response validation, (6) decomposed 820-line mermaid validation into `crux/lib/mermaid-checks.ts` (604 lines) + slim orchestrator (281 lines). Follow-up review integrated patterns.ts across 19+ files, fixed dead imports, corrected ToolHandler type, wired mdx-utils.ts to use shared patterns, replaced hardcoded model strings with MODELS constants, replaced `new Anthropic()` with `createLlmClient()`, replaced inline `extractText` implementations with shared `extractText()` from llm.ts, integrated `MARKDOWN_LINK_RE` into link validators, added `objectivityIssues` to the `AnalysisResult` type (removing an unsafe cast in utils.ts), fixed CI failure from eager client creation, and tested the full pipeline by improving 3 wiki pages. After manual review of 3 improved pages, fixed 8 systematic pipeline issues: (1) added content preservation instructions to prevent polish-tier content loss, (2) made auto-grading default after --apply, (3) added polish-tier citation suppression to prevent fabricated citations, (4) added Quick Assessment table requirement for person pages, (5) added required Overview section enforcement, (6) added section deduplication and content repetition checks to review phase, (7) added bare URL→markdown link conversion instruction, (8) extended biographical claim checker to catch publication/co-authorship and citation count claims.

Subsequent iterative testing and prompt refinement: ran pipeline on jan-leike, chris-olah, far-ai pages. Discovered and fixed: (a) `<!-- NEEDS CITATION -->` HTML comments break MDX compilation (changed to `{/* NEEDS CITATION */}`), (b) excessive citation markers at polish tier — added instruction to only mark NEW claims (max 3-5 per page), (c) editorial meta-comments cluttering output — added no-meta-comments instruction, (d) thin padding sections — added anti-padding instruction, (e) section deduplication needed stronger emphasis — added merge instruction with common patterns. Final test results: jan-leike 1254→1997 words, chris-olah 1187→1687 words, far-ai 1519→2783 words, miri-era 2678→4338 words; all MDX compile, zero critical issues.

**Issues encountered:**
- build-data.mjs expects `/home/user/data/` directory which doesn't exist in sandbox environment (pre-existing)
- `executeWebSearch` uses Anthropic's `web_search_20250305` tool type which required keeping the raw API call rather than abstracting to `streamLlmCall`
- Review agent flagged `validate/types.ts` as deleted — the file WAS deleted (in commit 9dd1d19) but the import in `validate-mermaid.ts` and `validate-internal-links.ts` is pre-existing and doesn't affect CI since those scripts are only loaded when their specific commands are invoked
- CI `validate` check failed because `crux.mjs` loads all command domains at startup, and `commands/updates.ts` → `page-improver.ts` → `pipeline.ts` → `api.ts` has a top-level `createLlmClient()` call that throws without `ANTHROPIC_API_KEY`. Fixed by making the client lazy.
- `withRetry()` from resilience.ts only retries on network/rate-limit errors, not arbitrary errors — the hand-rolled retry in `classifyWithHaiku` intentionally retries all errors (JSON parse failures, bad frequency values) so cannot be replaced

**Learnings/notes:**
- The `ValidationEngine.load()` scans all MDX files on every call - `validateSingleFile` still loads everything but only checks the target file. A future optimization could lazy-load only the target + its cross-references.
- The page-improver's `validatePhase` still shells out for `fix escaping` and `fix markdown` because those auto-fixers aren't rule-based (they do direct file transforms). These could be converted to validation engine rules in a follow-up.
- When sharing regex patterns with `g` flag across files, prefer `.matchAll()` or `.match()` over `.exec()` loops to avoid shared `lastIndex` state.
- `callClaude()` in anthropic.ts returns `{text, usage, model}` while `streamLlmCall` returns just `string` — a future unified API could return usage metadata optionally.
- Cannot use `extractText()` from llm.ts inside `callClaude()` in anthropic.ts due to circular dependency (llm.ts imports from anthropic.ts).
- Pipeline successfully ran all 3 pages end-to-end: analyze → improve → validate → auto-fix → MDX compile check. All EntityLinks resolved, all blocking checks passed.
- MDX does NOT support HTML comments (`<!-- -->`). Must use JSX-style `{/* */}`. LLM prompts must specify this format.
- Polish-tier citation markers need careful calibration: too many makes pages look like drafts, too few misses genuine gaps. Current limit of 3-5 per page works well.
- Anti-padding instructions ("Do NOT add thin, speculative sections") significantly improved output quality — without them, LLM creates many vague 2-3 bullet sections.

**Pages:** dan-hendrycks, neel-nanda, nick-bostrom, jan-leike, chris-olah, far-ai, miri-era
