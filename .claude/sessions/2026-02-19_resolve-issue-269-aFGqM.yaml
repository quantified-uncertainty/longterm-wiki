date: "2026-02-19"
branch: claude/resolve-issue-269-aFGqM
title: "fix(auto-update): deduplicate routing results and add budget floor"
issue: 269
pr: https://github.com/quantified-uncertainty/longterm-wiki/pull/333
model: claude-sonnet-4-6
duration: ~30min
cost: ~$0.20

summary: |
  Fixed two bugs in the auto-update page router (issue #269):

  1. Duplicate routing: extracted `deduplicatePageUpdates` helper that merges
     same-pageId entries in the final plan before limits are applied. Combines
     relevantNews arrays and takes the highest tier.

  2. Budget floor: extracted `applyBudgetAndPageLimits` helper that downgrades
     a page to 'polish' tier ($2.50) instead of skipping entirely when the
     assigned tier exceeds remaining budget. Prevents daily GitHub Actions runs
     with conservative budgets (~$5) from producing zero updates.

pages: []

changes:
  - file: crux/auto-update/page-router.ts
    description: >
      Extracted deduplicatePageUpdates and applyBudgetAndPageLimits as named
      exports. Eliminated inline tierRank DRY violation by using shared
      TIER_RANK constant. Budget downgrade uses spread copy to avoid mutating
      input objects.
  - file: crux/auto-update/page-router.test.ts
    description: >
      22 new unit tests covering both helpers: happy paths, edge cases
      (maxPages=0, maxBudget=0, empty input), no-mutation guarantee, tier
      merge/upgrade logic, insertion-order stability.

key_decisions:
  - "Extracted helpers as module-level exported functions for testability rather than keeping logic inline in routeDigest"
  - "Used spread copy ({ ...update, suggestedTier: 'polish' }) in budget downgrade to avoid mutating input objects â€” caught by paranoid review"
  - "Marked crux-typescript as N/A: pre-existing TypeScript errors in crux/ are unrelated to changed files (page-router.ts has zero errors)"

checks:
  initialized: true
  type: infrastructure
  initiated_at: "2026-02-19T16:29:06.447Z"
  total: 30
  completed: 27
  na: 3
  skipped: 0
  items:
    - read-issue
    - explore-code
    - plan-approach
    - tests-written
    - no-hardcoded
    - typescript-used
    - correctness
    - paranoid-review
    - shell-injection
    - security
    - no-dead-code
    - no-dry-violations
    - full-integration
    - no-regressions
    - backward-compatible
    - multi-environment
    - ci-coverage
    - self-audit-commands
    - self-audit-files
    - self-audit-no-fabrication
    - gate-passes
    - pr-description
    - issue-tracking
    - session-log
    - push-ci-green
    - no-merge-conflicts
    - check-recent-merges
