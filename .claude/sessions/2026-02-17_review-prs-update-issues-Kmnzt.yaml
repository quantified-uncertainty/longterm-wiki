date: 2026-02-17
branch: claude/review-prs-update-issues-Kmnzt
title: Add maintenance sweep system + scheduled workflow
pages: []
summary: "Added a comprehensive maintenance sweep system with a `/maintain` Claude Code command, a `crux maintain` CLI domain, and a shared `crux/lib/github.ts` utility. The system gathers signals from merged PRs, session logs, GitHub issues, and codebase analysis, then prioritizes work into P0-P5 categories with recommended cadences (daily/weekly/monthly). After initial implementation, performed a thorough 3-agent paranoid review and fixed all findings: replaced `execSync`+`curl` with native `fetch()`, aligned session log parser with canonical parser, added `--since` format validation, improved issue matching from naive 30-char substring to word-overlap ratio, added JSON output for full report, updated stale domain counts in `crux/README.md`, and extracted shared GitHub API utility used by both `maintain.ts` and `ci-status.ts`. Added a `scheduled-maintenance.yml` GitHub Actions workflow that runs Claude Code on daily/weekly/monthly cron schedules to execute maintenance sweeps automatically, with conservative issue handling (comment instead of close when uncertain)."
issues:
  - Initial `execSync` ENOBUFS error with curl for GitHub API — resolved by switching to native `fetch()`
  - The `gh` CLI not available in this environment — used `curl` for the slash command templates, `fetch()` for TypeScript
  - Review found session log parser was missing `\n---` terminator vs canonical parser — aligned terminators
  - Review found `--json` flag was silently ignored on full report — added proper JSON output path
  - 30-character prefix substring matching for issue triage produced false positives — replaced with word-overlap ratio >60%
learnings:
  - "Native `fetch()` is cleaner than `execSync`+`curl` for GitHub API: async, no shell escaping, proper HTTP status codes, typed responses"
  - Word-overlap matching (tokenize + ratio threshold) is much more robust than substring prefix matching for cross-referencing issue titles
  - Slash commands should delegate data gathering to CLI tools rather than duplicating logic — keeps the command as an orchestration layer
  - Session log parser terminators must stay aligned with canonical parser in `app/scripts/lib/session-log-parser.mjs` — the `\n---` case matters
  - Shared constants (REPO) across files prevent silent drift — extracted to `crux/lib/github.ts`
