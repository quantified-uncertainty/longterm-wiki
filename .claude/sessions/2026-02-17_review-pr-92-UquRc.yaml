date: 2026-02-17
branch: claude/review-pr-92-UquRc
title: Add Calc component + fact-aware improve pipeline
pages:
  - anthropic-ipo
summary: "Implemented `<Calc>` component from closed PR #92. Removed broken mechanical `crux fix facts` tool (too many false positives — can't distinguish \"$1B investment\" from \"$1B revenue\"). Replaced it with fact-aware improve pipeline: the LLM now receives a per-page fact lookup table during `crux content improve`, enabling semantic fact wrapping with full context."
pr: 186
issues:
  - "PR #92 branch was deleted from remote, so the implementation was rebuilt from the PR diff"
  - "Mechanical batch fact retrofitter had fatal false-positive problem: same dollar amounts in different semantic contexts got wrapped with wrong fact IDs"
  - Reverted all 29 batch-applied content files; kept only anthropic-ipo.mdx manual retrofit
learnings:
  - Mechanical regex-based fact matching fundamentally can't work — requires semantic understanding to distinguish e.g. "$1B investment" vs "$1B revenue" in same paragraph
  - The right approach is giving the LLM the fact lookup table during `crux content improve` — parallel to how entity lookup tables already work
  - New `crux/lib/fact-lookup.ts` builds per-page fact tables by matching entity names in content
  - Facts get wrapped incrementally as pages go through the improve pipeline, not via batch application
  - "`<Calc>` component and calc engine work well for derived values (ratios, multiples)"
