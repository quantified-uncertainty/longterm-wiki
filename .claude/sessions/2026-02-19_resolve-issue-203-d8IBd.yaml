date: 2026-02-19
branch: claude/resolve-issue-203-d8IBd
title: "Pass 3: Calc Derivation — wrap derived quantities with <Calc>"
model: sonnet-4
duration: ~45min
pages: []
summary: >
  Implemented the `pnpm crux facts calc` command (Pass 3 of the canonical
  facts pipeline). Creates a standalone expression evaluator (crux/lib/calc-evaluator.ts),
  a main calc-derive script (crux/facts/calc-derive.ts) that detects hardcoded
  derived quantities in MDX pages and proposes LLM-generated <Calc> expressions
  with validation, and 29 unit tests covering pattern detection, expression evaluation,
  MDX transformation, and import management.
issues:
  - None
learnings:
  - The calc-engine in app/src/lib/ uses Next.js path aliases, so a standalone copy
    was needed for the crux CLI. The tokenizer/evaluator logic was ported cleanly.
  - Following the extract-facts.test.ts pattern of inline-copying pure functions
    avoids side effects from main() running during test import.
  - The `buildCommands` pattern in crux/lib/cli.ts makes adding new sub-commands
    to existing domains very straightforward — just add an entry to the SCRIPTS map.
recommendations:
  - Consider exporting pure utility functions from calc-derive.ts directly rather than
    requiring test files to inline-copy them. This would make refactoring safer.
  - The entityDisplayNames map in both fact-lookup.ts and calc-derive.ts is duplicated
    — could be consolidated into a shared crux/lib/entity-names.ts utility.
