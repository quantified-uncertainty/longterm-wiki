date: "2026-02-21"
branch: claude/cleanup-smoke-test-data-ujv40
title: "fix: clean up __smoke-test__ page after post-deploy smoke test"
issue: 517
pr: "https://github.com/quantified-uncertainty/longterm-wiki/pull/new/claude/cleanup-smoke-test-data-ujv40"
model: claude-sonnet-4-6
duration: "~20 min"
cost: "~$0.50"

summary: |
  The post-deploy smoke test in wiki-server-docker.yml was inserting a
  __smoke-test__ page via POST /api/pages/sync on every deploy but never
  cleaning it up, leaving a junk row accumulating in the production database.

  Added DELETE /api/pages/:id endpoint to the wiki-server pages router (auth-
  gated by the existing bearer-auth middleware), and added a workflow cleanup
  step that calls it after verifying the sync upsert succeeded.

changes:
  - apps/wiki-server/src/routes/pages.ts: new DELETE /:id handler
  - .github/workflows/wiki-server-docker.yml: cleanup step 3 in smoke test
  - apps/wiki-server/src/__tests__/pages.test.ts: 3 new DELETE endpoint tests

key_decisions:
  - DELETE endpoint is server-side (not a workflow-only raw SQL step) so it is
    testable, reusable, and consistent with the REST API pattern.
  - Auth is inherited from the /api/* bearer-auth middleware in app.ts.
  - Cleanup step fails on 404 (non-idempotent) which is acceptable; the linear
    workflow guarantees the row exists before cleanup runs.

checks:
  initialized: true
  type: infrastructure
  initiated_at: "2026-02-21T19:31:51.145Z"
  total: 32
  completed: 20
  na: 6
  skipped: 6
  items:
    - read-issue
    - explore-code
    - plan-approach
    - tests-written
    - typescript-used
    - correctness
    - paranoid-review
    - shell-injection
    - security
    - no-dead-code
    - no-dry-violations
    - full-integration
    - no-regressions
    - backward-compatible
    - tooling-gaps-found
    - self-audit-commands
    - self-audit-files
    - self-audit-no-fabrication
    - gate-passes
    - tooling-gaps-actioned
