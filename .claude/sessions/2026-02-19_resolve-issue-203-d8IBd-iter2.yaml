date: 2026-02-19
branch: claude/resolve-issue-203-d8IBd
title: "Calc pipeline iteration: fix range facts, index mismatch, prompt quality"
model: sonnet-4
duration: ~40min
pages:
  - anthropic-valuation
  - anthropic
summary: >
  Ran `crux facts calc` on anthropic-valuation and anthropic pages post-implementation,
  discovered and fixed three bugs: (1) range-valued facts ({min: N}) invisible to LLM
  and evaluator, (2) proposal-to-pattern index mismatch causing wrong validation expected
  values, (3) over-wide originalText proposals including JSX tags or prose. Applied
  validated Calc replacements to two pages (openai.39d6868e/$500B valuation now computes correctly).
issues:
  - Range facts like {value: {min: 500000000000}} returned null from both formatFactsForPrompt
    and buildFactLookup — added extractNumericFromFact() helper that handles {min}, {max},
    {min+max} range objects
  - Proposal validation was index-based (proposals[i] vs patterns[i]) but LLM filters null
    proposals, causing drift — fixed to match by originalText substring
  - LLM tends to widen originalText to disambiguate identical patterns — added structural
    validation guards (JSX tags, table pipes, excess width, prose in suffix) and improved
    prompt guidance
learnings:
  - Facts with {value: {min: N}} are common for valuations — easy to miss since they
    look like numbers but fail the typeof === 'number' check
  - When identical patterns appear multiple times, disambiguation via widening originalText
    is error-prone; better to replace first occurrence per run and let the tool iterate
  - Named-multiple patterns ("39x multiple") need special guidance: replace only the
    number portion in originalText, leave the word "multiple" as surrounding prose
recommendations:
  - The extractNumericFromFact helper is now in calc-derive.ts but also needed in
    fact-lookup.ts — consolidating into crux/lib/fact-utils.ts would help (see issue #313)
  - Consider adding a --max-passes flag to run the pipeline N times until no patterns remain
