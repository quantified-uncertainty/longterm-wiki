date: "2026-02-21"
branch: claude/fix-summaries-null-guard-UzsIf
title: "Fix: use firstOrThrow() instead of rows[0] after .returning() in summaries and claims POST endpoints"
issue: 516
pr: ""
model: claude-sonnet-4-6
duration: ~10m
cost: ~$0.10
pages: []

summary: |
  Fixed a null-guard bug in the summaries POST endpoint where rows[0] was accessed after
  .returning() without checking if the insert returned any rows. If the DB insert failed
  silently, rows[0] would be undefined, causing the endpoint to return undefined as JSON.
  Replaced with firstOrThrow(rows, "summary upsert") — consistent with how all other
  wiki-server routes handle this pattern (edit-logs, sessions, resources, hallucination-risk,
  citations). Also fixed the identical bug in claims.ts POST /.

key_decisions:
  - "Used existing firstOrThrow helper from utils.ts — already exported and used by 5+ other route files"
  - "Fixed claims.ts too: same rows[0] after .returning() pattern at claims.ts:92"
  - "No new tests: pure null-guard fix using already-tested helper; existing integration tests cover the endpoints"
  - "Tooling gap filed as #522: add ESLint rule to flag rows[0] after .returning() without firstOrThrow guard"

files_changed:
  - apps/wiki-server/src/routes/summaries.ts
  - apps/wiki-server/src/routes/claims.ts

checks:
  initialized: true
  type: infrastructure
  initiated_at: "2026-02-21T19:31:40.890Z"
  total: 32
  completed: 25
  na: 4
  skipped: 3
  items:
    - read-issue
    - explore-code
    - plan-approach
    - no-hardcoded
    - typescript-used
    - correctness
    - shell-injection
    - security
    - no-dead-code
    - no-dry-violations
    - full-integration
    - no-regressions
    - live-data-test
    - backward-compatible
    - multi-environment
    - ci-coverage
    - tooling-gaps-found
    - self-audit-commands
    - self-audit-files
    - self-audit-no-fabrication
    - gate-passes
    - pr-description
    - session-log
    - check-recent-merges
    - tooling-gaps-actioned
