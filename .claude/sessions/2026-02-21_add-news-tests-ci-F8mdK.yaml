date: "2026-02-21"
branch: claude/add-news-tests-ci-F8mdK
title: "ci: wire crux vitest tests into build-and-test CI job"
issues: [531, 535]
pr: https://github.com/quantified-uncertainty/longterm-wiki/pull/549
model: claude-sonnet-4-6
duration: ~35min
cost: ~$2

summary: |
  Wired the crux vitest test suite into the CI build-and-test job by adding a
  "Run crux tests" step that runs `pnpm test:crux`. The crux suite covers ~60
  test files (sync scripts, authoring pipeline, validation rules, wiki-server
  client, etc.) that previously never ran in CI.

  Also wrote auto-update-news.test.ts (18 tests for all 5 endpoints) but
  discovered PR #527 had already merged a more comprehensive version (28 tests).
  Rebased onto main, discarded my test file in favour of the existing one,
  and kept only the CI step as the meaningful change for issue #531.

key_decisions:
  - "Rebase over conflict: PR #527 had already delivered tests for auto-update-news
    (#514/#535). Accepted their 28-test version over my 18-test version."
  - "Dispatch pattern for jsonb: discovered Drizzle serializes jsonb arrays to
    JSON strings before passing to the mock driver. Fixed with JSON.parse() in
    INSERT handler. Document this for future test authors."
  - "Only CI change shipped: the sole diff in the PR is +3 lines in ci.yml."

tooling_gaps: |
  - No gap: the test:crux script existed; the only gap was it wasn't wired to CI.
  - No new issues filed (the wiring was the whole task).

checks:
  initialized: true
  type: infrastructure
  initiated_at: "2026-02-21T21:27:09.495Z"
  total: 32
  completed: 26
  na: 0
  skipped: 6
  items:
    - read-issue
    - explore-code
    - plan-approach
    - tests-written
    - no-hardcoded
    - fix-escaping
    - typescript-used
    - correctness
    - paranoid-review
    - shell-injection
    - security
    - no-dead-code
    - no-dry-violations
    - full-integration
    - no-regressions
    - live-data-test
    - backward-compatible
    - multi-environment
    - ci-coverage
    - tooling-gaps-found
    - self-audit-commands
    - self-audit-files
    - self-audit-no-fabrication
    - gate-passes
    - no-merge-conflicts
    - check-recent-merges
