date: 2026-02-19
branch: claude/issue-130-longterm-wiki-dqhSZ
title: "Add adversarial reviewer with re-research feedback loop (issue #130)"
model: sonnet-4
duration: ~2h
pages: []
summary: >
  Implemented the adversarial reviewer + re-research feedback loop from issue #130.
  Added adversarial-review.ts (5-check diagnostic reviewer) and adversarial-loop.ts
  (compound loop: adversarial-review → targeted-research → re-improve × N). After
  testing on real pages, a full code review found and fixed 7 issues: critical bug where
  improvePhase always re-read from disk (defeating the loop), schemas moved to
  json-parsing.ts as SSOT, new CLI flags (--adversarial-model, --max-adversarial-iterations),
  adversarialLoopResult added to PipelineResults, edit-log enriched with adversarial metadata,
  URL deduplication in mergeResearch, and 29 unit tests added.
  GitHub issues #317 and #318 opened for deferred improvements.
issues:
  - Pre-existing TypeScript errors in crux/ (327 lines, not introduced by this PR).
  - >-
    Critical bug caught post-initial-implementation: improvePhase read from disk unconditionally,
    so adversarial loop iterations all re-improved from original file instead of previous output.
    Fixed with contentOverride optional parameter.
learnings:
  - Always pass in-memory content explicitly when chaining phases that can read from disk — never
    assume the phase will use the right source just because it's called with the same PageData.
  - >-
    Schema SSOT: all Zod schemas for LLM responses belong in phases/json-parsing.ts. Defining
    them elsewhere creates drift and duplicate type casts.
  - >-
    Testing private functions: re-implement module-private pure functions inline in test files
    rather than exporting them just for testing. Document this in the test file header.
  - The adversarial reviewer must use a separate model call from synthesis — prevents the model
    from defending its own output (as noted in the original issue).
recommendations:
  - Centralize page-type detection and PAGE_TYPE_STANDARD_DATA into a shared utility
    (tracked as GitHub issue #317).
  - Expose adversarial-review as a standalone CLI command for one-off use without running
    the full pipeline (tracked as GitHub issue #318).
  - Consider surfacing adversarial-review.json output in an internal dashboard alongside
    page quality scores.
