# Longterm Wiki - Claude Code Config

Next.js 15 App Router wiki frontend for the AI safety knowledge base. Standalone repository — content, data, and tooling all live in this repo.

## Quick Reference

```bash
# Development (from app/)
pnpm dev                     # Start dev server on port 3001
node scripts/build-data.mjs  # Rebuild database.json (required before first build)

# Build & Test (from app/)
pnpm build                   # Production build (runs prebuild automatically)
pnpm test                    # Run vitest tests
pnpm test:watch              # Watch mode

# Tooling (from repo root)
node tooling/crux.mjs validate   # Run validation suite
```

## Essential Conventions

### Import Path Aliases
**Always use path aliases instead of relative imports.** Configured in `tsconfig.json`:
```tsx
// Good
import { getEntityById } from "@/data";
import { InfoBox } from "@/components/wiki/InfoBox";
import { renderMdxPage } from "@/lib/mdx";

// Bad
import { getEntityById } from "../../data";
```

Available aliases:
- `@/*` → `src/*` (general)
- `@components/*` → `src/components/*`
- `@data` → `src/data/index.ts`
- `@data/*` → `src/data/*`
- `@lib/*` → `src/lib/*`

### Styling
- **Tailwind CSS v4** with `@import "tailwindcss"` syntax
- CSS custom properties for theming in `globals.css` (oklch color space)
- shadcn/ui components in `src/components/ui/`
- Prefer Tailwind classes over custom CSS. Use globals.css only for styles that can't be expressed as Tailwind (e.g., prose typography, generated footnotes)

### MDX Components
All MDX components are registered in `src/components/mdx-components.tsx`. Import statements in MDX source are stripped by `preprocessMdx()` — components are injected globally.

Key ported components: `EntityLink`, `ResourceLink`, `R`, `F`, `DataInfoBox`, `Backlinks`, `InfoBox`, `ExternalLinks`, `MermaidDiagram`, `SquiggleEstimate`, `Callout`

42+ stub components exist for not-yet-ported Astro components.

## Repository Structure

```
longterm-wiki/
├── content/docs/              # ~625 MDX wiki pages
├── data/                      # YAML sources
│   ├── entities/              # 24 YAML entity files
│   ├── facts/                 # Canonical facts
│   ├── resources/             # External resource links
│   ├── insights/              # Extracted insights
│   ├── graphs/                # Causal graph YAML
│   └── id-registry.json       # Persistent entity ID mapping
├── app/                       # Next.js 15 frontend (this directory)
│   ├── src/
│   │   ├── app/               # App Router pages
│   │   ├── components/        # React components
│   │   ├── data/              # Data layer (reads database.json)
│   │   └── lib/               # Utilities (MDX, nav, etc.)
│   ├── scripts/               # Build scripts (build-data.mjs)
│   └── public/                # Static assets + LLM files
├── tooling/                   # Crux CLI + validation
│   ├── crux.mjs               # CLI entry point
│   ├── commands/              # Command domains
│   ├── lib/                   # Shared utilities + rules
│   └── validate/              # Validation scripts
└── package.json               # Workspace root
```

## Data Layer

The app reads `src/data/database.json` at build/server time. This file is generated by `node scripts/build-data.mjs` which reads YAML from `../data/` and MDX frontmatter from `../content/docs/`.

### Entity Sources
Entities come from two sources (merged at build time, YAML takes precedence):
1. YAML files in `data/entities/*.yaml` — rich entities with relatedEntries, sources, etc.
2. MDX frontmatter `entityType` field — auto-creates minimal entities for pages without YAML entries

Key data functions in `src/data/index.ts`:
- `getEntityById(id)` — Entity lookup
- `getPageById(id)` — Page metadata (quality, importance, lastUpdated, etc.)
- `getBacklinksFor(id)` — Reverse references
- `getFact(entityId, factId)` — Canonical fact lookup
- `getExploreItems()` — All items for browse page
- `getEntityHref(id)` — Canonical URL (uses numeric IDs like E42)

### ID System
Entities have both string slugs (`geoffrey-hinton`) and numeric IDs (`E42`). Wiki pages use numeric IDs as canonical URLs. The `idRegistry` maps between them.

## Key Patterns

### Server Components (default)
All pages and most components are React Server Components. Only add `"use client"` when needed for interactivity (e.g., `DevModeToggle`, `ExploreGrid`, `SquiggleEstimate`).

### Static Generation
Wiki pages use `generateStaticParams()` to pre-render all pages at build time from the ID registry.

### Content Pipeline
1. MDX files live in `content/docs/` (repo root)
2. `preprocessMdx()` strips imports and Astro directives
3. `compileMDX()` from next-mdx-remote/rsc compiles with remark/rehype plugins
4. Components injected via `mdxComponents` map

### Canonical Facts
Facts are defined in `data/facts/*.yaml`, computed by `build-data.mjs`, and accessed via `getFact(entity, factId)`. The `<F>` component renders inline fact values.

### Content Architecture
Content directories are **flat** (max 2 levels). Grouping is done via frontmatter `subcategory` metadata, not directory nesting:
```
knowledge-base/models/          # All models flat — no risk-models/ subdirectory
ai-transition-model/            # All ATM pages flat — no factors/ subdirectory
```
Each page's `subcategory` field (e.g., `risk-models`, `factors-ai-capabilities`) is extracted at build time and used for sidebar navigation grouping.

### Wiki Sidebar Navigation
`src/lib/wiki-nav.ts` builds contextual sidebars for Models and ATM pages. It uses `page.subcategory` for grouping — **not** file path parsing. The `detectSidebarType()` function checks top-level path prefixes to decide which sidebar to show.

### Entity Type System
- **Canonical types** are defined in `src/data/entity-ontology.ts` (labels, icons, colors, badges)
- **Build-time remapping**: `build-data.mjs` remaps raw YAML types (e.g., `response` → `approach`)
- **Runtime enrichment**: `src/data/index.ts` `transformEntity()` merges expert data (role, affiliation), assigns org subtypes (lab-* → organization + orgType), and assigns risk categories
- Legacy types still in database.json: `lab`, `lab-academic`, `lab-research`, `researcher` (remapped at runtime)

## Squiggle Model Style Guide

When creating or editing `<SquiggleEstimate>` models in MDX pages:

- **Never use point values in mixtures.** `mixture(500e9, 350e9, ...)` creates jagged spikes. Use distributions: `mixture(400e9 to 650e9, 250e9 to 450e9, ...)`.
- **Use `X to Y` syntax** for quantities with uncertainty. Reserve `normal()` for symmetric quantities near zero.
- **Keep models 5–30 lines.** Break larger analyses into multiple blocks.
- **Always add a title**: `<SquiggleEstimate title="Descriptive Title" code={...} />`.
- **Name variables clearly**: `founderEquity`, not `x` or `temp`.
- Default `sampleCount` is 5000. The `squiggle-quality` validation rule enforces these conventions.
