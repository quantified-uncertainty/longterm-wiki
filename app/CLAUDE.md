# Longterm-Next - Claude Code Config

Next.js 15 App Router wiki frontend for the Cairn AI safety knowledge base. Consumes MDX content and database.json from the sibling `apps/longterm` Astro app.

## Quick Reference

```bash
# Development
pnpm --filter longterm-next dev     # Start dev server on port 3001
pnpm --filter longterm build:data   # Rebuild database.json (required before first build)

# Build & Test
pnpm --filter longterm-next build   # Production build (runs build:data automatically via prebuild)
pnpm --filter longterm-next test    # Run vitest tests
pnpm --filter longterm-next test:watch  # Watch mode
```

## Essential Conventions

### Import Path Aliases
**Always use path aliases instead of relative imports.** Configured in `tsconfig.json`:
```tsx
// ✅ Good
import { getEntityById } from "@/data";
import { InfoBox } from "@/components/wiki/InfoBox";
import { renderMdxPage } from "@/lib/mdx";

// ❌ Bad
import { getEntityById } from "../../data";
```

Available aliases:
- `@/*` → `src/*` (general)
- `@components/*` → `src/components/*`
- `@data` → `src/data/index.ts`
- `@data/*` → `src/data/*`
- `@lib/*` → `src/lib/*`

### Styling
- **Tailwind CSS v4** with `@import "tailwindcss"` syntax
- CSS custom properties for theming in `globals.css` (oklch color space)
- shadcn/ui components in `src/components/ui/`
- Prefer Tailwind classes over custom CSS. Use globals.css only for styles that can't be expressed as Tailwind (e.g., prose typography, generated footnotes)

### MDX Components
All MDX components are registered in `src/components/mdx-components.tsx`. Import statements in MDX source are stripped by `preprocessMdx()` — components are injected globally.

Key ported components: `EntityLink`, `ResourceLink`, `R`, `F`, `DataInfoBox`, `Backlinks`, `InfoBox`, `ExternalLinks`, `MermaidDiagram`, `SquiggleEstimate`, `Callout`

42+ stub components exist for not-yet-ported Astro components.

## Project Structure

```
src/
├── app/                    # Next.js App Router pages
│   ├── layout.tsx          # Root layout (header, nav)
│   ├── globals.css         # Theme variables, prose styles
│   ├── wiki/               # Wiki article pages
│   │   ├── [id]/page.tsx   # Dynamic wiki page (E42 or slug)
│   │   └── page.tsx        # Explore/browse page
│   └── internal/           # Internal documentation pages
│       └── [[...slug]]/    # Catch-all for internal MDX
├── components/
│   ├── wiki/               # Wiki-specific components
│   │   ├── EntityLink.tsx  # Cross-reference links with tooltips
│   │   ├── InfoBox.tsx     # Sidebar info boxes
│   │   ├── F.tsx           # Canonical fact inline component
│   │   └── shared/         # Shared utilities (style-config, etc.)
│   ├── explore/            # Explore page grid/filters
│   ├── ui/                 # shadcn/ui primitives
│   ├── mdx-components.tsx  # MDX component registry
│   ├── PageStatus.tsx      # Dev-mode quality panel
│   └── DevModeToggle.tsx   # Header dev mode button
├── data/
│   ├── index.ts            # Data layer (reads database.json from longterm)
│   ├── entity-ontology.ts  # Canonical type definitions, icons, colors
│   └── entity-schemas.ts   # Zod schemas for typed entities
└── lib/
    ├── mdx.ts              # MDX compilation, path resolution, static params
    ├── wiki-nav.ts          # Wiki sidebar navigation (models, ATM)
    ├── remark-callouts.ts  # Remark plugin for :::note directives
    └── utils.ts            # cn() helper
```

**Important:** This app has NO local content or entity YAML files. All content lives in `apps/longterm/src/content/docs/` and all data in `apps/longterm/src/data/`. The app reads directly from those directories.

## Data Layer

The app reads `apps/longterm/src/data/database.json` at build/server time. This file is generated by `pnpm --filter longterm build:data`.

### Entity Sources
Entities come from two sources (merged at build time, YAML takes precedence):
1. YAML files in `apps/longterm/src/data/entities/*.yaml` — rich entities with relatedEntries, sources, etc.
2. MDX frontmatter `entityType` field — auto-creates minimal entities for pages without YAML entries

Key data functions in `src/data/index.ts`:
- `getEntityById(id)` — Entity lookup
- `getPageById(id)` — Page metadata (quality, importance, lastUpdated, etc.)
- `getBacklinksFor(id)` — Reverse references
- `getFact(entityId, factId)` — Canonical fact lookup
- `getExploreItems()` — All items for browse page
- `getEntityHref(id)` — Canonical URL (uses numeric IDs like E42)

### ID System
Entities have both string slugs (`geoffrey-hinton`) and numeric IDs (`E42`). Wiki pages use numeric IDs as canonical URLs. The `idRegistry` maps between them.

## Key Patterns

### Server Components (default)
All pages and most components are React Server Components. Only add `"use client"` when needed for interactivity (e.g., `DevModeToggle`, `ExploreGrid`, `SquiggleEstimate`).

### Static Generation
Wiki pages use `generateStaticParams()` to pre-render all pages at build time from the ID registry.

### Content Pipeline
1. MDX files live in `apps/longterm/src/content/docs/`
2. `preprocessMdx()` strips imports and Astro directives
3. `compileMDX()` from next-mdx-remote/rsc compiles with remark/rehype plugins
4. Components injected via `mdxComponents` map

### Canonical Facts
Facts are defined in `apps/longterm/src/data/facts/*.yaml`, computed by `build-data.mjs`, and accessed via `getFact(entity, factId)`. The `<F>` component renders inline fact values.

### Content Architecture
Content directories are **flat** (max 2 levels). Grouping is done via frontmatter `subcategory` metadata, not directory nesting:
```
knowledge-base/models/          # All models flat — no risk-models/ subdirectory
ai-transition-model/            # All ATM pages flat — no factors/ subdirectory
```
Each page's `subcategory` field (e.g., `risk-models`, `factors-ai-capabilities`) is extracted at build time and used for sidebar navigation grouping.

### Wiki Sidebar Navigation
`src/lib/wiki-nav.ts` builds contextual sidebars for Models and ATM pages. It uses `page.subcategory` for grouping — **not** file path parsing. The `detectSidebarType()` function checks top-level path prefixes to decide which sidebar to show.

### Entity Type System
- **Canonical types** are defined in `src/data/entity-ontology.ts` (labels, icons, colors, badges)
- **Build-time remapping**: `build-data.mjs` remaps raw YAML types (e.g., `response` → `approach`)
- **Runtime enrichment**: `src/data/index.ts` `transformEntity()` merges expert data (role, affiliation), assigns org subtypes (lab-* → organization + orgType), and assigns risk categories
- Legacy types still in database.json: `lab`, `lab-academic`, `lab-research`, `researcher` (remapped at runtime)
