name: Staged Merge Pipeline

# Gate G: PR → staging → extended validation → auto-promote to main
#
# Instead of merging directly to main, PRs merge to a staging branch
# where extended validation runs (full build, consistency checks, etc).
# If all checks pass, staging is automatically promoted to main.
#
# This gives a safety buffer: if a PR breaks something that fast CI
# didn't catch, it's caught on staging before reaching main.

on:
  # Runs on a schedule — batch-promotes staging to main
  schedule:
    # Every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'

  # Also run on-demand via workflow dispatch
  workflow_dispatch:
    inputs:
      force:
        description: 'Force promote even if validation has warnings'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-promote:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if staging is ahead of main
        id: check
        run: |
          set -euo pipefail

          git fetch origin main

          STAGING_SHA=$(git rev-parse HEAD)
          MAIN_SHA=$(git rev-parse origin/main)

          if [ "$STAGING_SHA" = "$MAIN_SHA" ]; then
            echo "Staging is identical to main. Nothing to promote."
            echo "should_promote=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD)
          echo "Staging is $COMMITS_AHEAD commit(s) ahead of main."
          echo "should_promote=true" >> "$GITHUB_OUTPUT"
          echo "commits_ahead=$COMMITS_AHEAD" >> "$GITHUB_OUTPUT"

      - uses: pnpm/action-setup@v4
        if: steps.check.outputs.should_promote == 'true'

      - uses: actions/setup-node@v4
        if: steps.check.outputs.should_promote == 'true'
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        if: steps.check.outputs.should_promote == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build data layer
        if: steps.check.outputs.should_promote == 'true'
        run: cd app && node scripts/build-data.mjs

      - name: Run tests
        if: steps.check.outputs.should_promote == 'true'
        run: pnpm test

      - name: MDX syntax check (blocking)
        if: steps.check.outputs.should_promote == 'true'
        run: pnpm crux validate unified --rules=comparison-operators,dollar-signs --errors-only

      - name: YAML schema validation (blocking)
        if: steps.check.outputs.should_promote == 'true'
        run: pnpm crux validate schema

      - name: Frontmatter schema validation (blocking)
        if: steps.check.outputs.should_promote == 'true'
        run: pnpm crux validate unified --rules=frontmatter-schema --errors-only

      - name: Full Next.js build
        if: steps.check.outputs.should_promote == 'true'
        run: cd app && pnpm build

      - name: Extended validation (advisory)
        if: steps.check.outputs.should_promote == 'true'
        id: advisory
        continue-on-error: true
        run: |
          pnpm crux validate consistency --ci > /tmp/consistency.json 2>&1 || true
          pnpm crux validate unified --rules=value-consistency --ci > /tmp/value-consistency.json 2>&1 || true
          echo "Advisory checks completed (non-blocking)."

      - name: Promote staging to main
        if: steps.check.outputs.should_promote == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          STAGING_SHA=$(git rev-parse HEAD)

          # Fast-forward main to staging (safe — no force push)
          git checkout main
          git merge --ff-only "$STAGING_SHA"
          git push origin main

          echo "Promoted staging ($STAGING_SHA) to main."
