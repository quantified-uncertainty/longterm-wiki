name: Weekly Wiki Health Report

# Generates a comprehensive health dashboard by running crux analysis,
# validation, and statistics commands, then posts/updates a GitHub issue.

on:
  schedule:
    - cron: "0 8 * * 1" # Every Monday at 8am UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  contents: read

jobs:
  health-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build data
        run: cd app && node scripts/build-data.mjs

      - name: Run health analysis
        id: analyze
        run: |
          set -euo pipefail

          # Collect all reports into a temp directory
          mkdir -p /tmp/reports

          # 1. Full validation suite (capture exit code but don't fail)
          pnpm crux validate --ci > /tmp/reports/validate.json 2>&1 || true

          # 2. Update queue stats
          pnpm crux updates stats --json > /tmp/reports/updates.json 2>&1 || true

          # 3. Update queue - overdue pages
          pnpm crux updates list --overdue --json --limit=20 > /tmp/reports/overdue.json 2>&1 || true

          # 4. Insight coverage stats
          pnpm crux gaps stats --json > /tmp/reports/gaps.json 2>&1 || true

          # 5. Insight quality checks
          pnpm crux insights check --ci > /tmp/reports/insights.json 2>&1 || true

          # 6. Link coverage analysis
          pnpm crux analyze links --json > /tmp/reports/links.json 2>&1 || true

          # 7. Edit log stats
          pnpm crux edit-log stats --json > /tmp/reports/edit-logs.json 2>&1 || true

          echo "reports_collected=true" >> "$GITHUB_OUTPUT"

      - name: Generate report issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          DATE=$(date -u +"%Y-%m-%d")

          # Parse JSON reports into markdown sections
          BODY=$(python3 << 'PYEOF'
          import json, os, sys
          from datetime import datetime

          def safe_load(path):
              try:
                  with open(path) as f:
                      return json.load(f)
              except:
                  return None

          date = datetime.utcnow().strftime("%Y-%m-%d")
          lines = []
          lines.append(f"# Wiki Health Report — {date}\n")
          lines.append("*Auto-generated by the weekly health report workflow.*\n")

          # --- Update Queue ---
          updates = safe_load("/tmp/reports/updates.json")
          if updates:
              lines.append("## Update Queue\n")
              lines.append(f"- **Tracked pages:** {updates.get('pagesWithFrequency', '?')}")
              lines.append(f"- **Coverage:** {updates.get('coveragePercent', '?')}% of content pages")
              lines.append(f"- **Currently overdue:** {updates.get('overdueCount', '?')}")
              lines.append(f"- **Avg staleness:** {updates.get('avgStaleness', '?')}x")
              lines.append(f"- **Avg priority:** {updates.get('avgPriority', '?')}")
              lines.append("")

          # --- Overdue Pages ---
          overdue = safe_load("/tmp/reports/overdue.json")
          if overdue and isinstance(overdue, list) and len(overdue) > 0:
              lines.append("### Top Overdue Pages\n")
              lines.append("| Priority | Page | Days Since Edit | Frequency | Importance |")
              lines.append("|----------|------|-----------------|-----------|------------|")
              for p in overdue[:15]:
                  lines.append(f"| {p.get('priority', '?')} | {p.get('title', '?')} | {p.get('daysSinceEdit', '?')}d | {p.get('updateFrequency', '?')}d | {p.get('importance', '?')} |")
              lines.append("")

          # --- Insight Coverage ---
          gaps = safe_load("/tmp/reports/gaps.json")
          if gaps:
              lines.append("## Insight Coverage\n")
              lines.append(f"- **Total insights:** {gaps.get('totalInsights', '?')}")
              lines.append(f"- **Pages with insights:** {gaps.get('pagesWithInsights', '?')} ({gaps.get('coverage', '?')}%)")
              lines.append(f"- **High-importance, no insights:** {gaps.get('highImportanceNoInsights', '?')}")
              lines.append(f"- **Avg insights per page:** {gaps.get('avgInsightsPerPage', '?')}")
              lines.append("")

          # --- Insight Quality ---
          insights = safe_load("/tmp/reports/insights.json")
          if insights:
              lines.append("## Insight Quality\n")
              total_issues = insights.get("totalIssues", 0)
              passed = insights.get("passed", False)
              status = "All checks passed" if passed else f"{total_issues} issues found"
              lines.append(f"- **Status:** {status}")
              lines.append(f"- **Total insights:** {insights.get('total', '?')}")
              lines.append(f"- **Checks run:** {insights.get('checksRun', '?')}")
              # Show per-check results
              results = insights.get("results", {})
              for check_name, check_data in results.items():
                  icon = "pass" if check_data.get("passed") else "FAIL"
                  issue_count = len(check_data.get("issues", []))
                  lines.append(f"  - `{check_name}`: {icon} ({issue_count} issues)")
              lines.append("")

          # --- Validation Summary ---
          # The full validate output varies, just note it ran
          lines.append("## Validation\n")
          lines.append("Full validation suite was run. Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed output.\n")

          # --- Footer ---
          lines.append("---")
          lines.append(f"*Report generated: {date} | [Workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*")

          print("\n".join(lines))
          PYEOF
          )

          # Find or create the health report issue
          ISSUE_NUMBER=$(gh issue list --repo "$GITHUB_REPOSITORY" \
            --label "wiki-health" --state open --json number \
            --jq '.[0].number // empty' 2>/dev/null || true)

          if [ -n "$ISSUE_NUMBER" ]; then
            # Update existing issue
            gh issue edit "$ISSUE_NUMBER" --repo "$GITHUB_REPOSITORY" \
              --title "Wiki Health Report — $DATE" \
              --body "$BODY"
            echo "Updated issue #$ISSUE_NUMBER"
          else
            # Create label if it doesn't exist
            gh label create "wiki-health" --repo "$GITHUB_REPOSITORY" \
              --description "Auto-generated wiki health reports" \
              --color "0075ca" 2>/dev/null || true

            # Create new issue
            gh issue create --repo "$GITHUB_REPOSITORY" \
              --title "Wiki Health Report — $DATE" \
              --label "wiki-health" \
              --body "$BODY"
            echo "Created new health report issue"
          fi
