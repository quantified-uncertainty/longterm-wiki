name: Database Restore

on:
  workflow_dispatch:
    inputs:
      backup_run_id:
        description: "GitHub Actions run ID containing the backup artifact"
        required: true
        type: string
      backup_filename:
        description: "Backup filename (e.g., longterm-wiki-scheduled-20240101_020000.sql.gz)"
        required: true
        type: string
      confirm:
        description: "Type RESTORE to confirm"
        required: true
        type: string

jobs:
  restore:
    name: Restore database
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'RESTORE'

    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'RESTORE'
        run: |
          echo "::error::You must type RESTORE to confirm the restore operation."
          exit 1

      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16

      - name: Install Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download backup artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.backup_filename }}
          run-id: ${{ github.event.inputs.backup_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create pre-restore safety backup
        id: safety-backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Parse DATABASE_URL
          PROTO="$(echo "$DATABASE_URL" | grep :// | sed -e 's,^\(.*://\).*,\1,g')"
          URL="${DATABASE_URL/$PROTO/}"
          USERPASS="$(echo "$URL" | cut -d@ -f1)"
          HOSTPORT_DB="$(echo "$URL" | cut -d@ -f2)"
          DB_USER="$(echo "$USERPASS" | cut -d: -f1)"
          DB_PASS="$(echo "$USERPASS" | cut -d: -f2)"
          DB_HOST="$(echo "$HOSTPORT_DB" | cut -d: -f1)"
          DB_PORT="$(echo "$HOSTPORT_DB" | cut -d: -f2 | cut -d/ -f1)"
          DB_NAME="$(echo "$HOSTPORT_DB" | cut -d/ -f2 | cut -d? -f1)"

          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SAFETY_FILENAME="longterm-wiki-pre-restore-${TIMESTAMP}.sql.gz"
          echo "safety_filename=${SAFETY_FILENAME}" >> "$GITHUB_OUTPUT"

          echo "Creating pre-restore safety backup: ${SAFETY_FILENAME}"
          PGPASSWORD="${DB_PASS}" pg_dump \
            -h "${DB_HOST}" \
            -p "${DB_PORT}" \
            -U "${DB_USER}" \
            -d "${DB_NAME}" \
            --no-owner \
            --no-privileges \
            2>&1 | gzip > "${SAFETY_FILENAME}"

          FILE_SIZE=$(du -h "${SAFETY_FILENAME}" | cut -f1)
          echo "Safety backup completed: ${SAFETY_FILENAME} (${FILE_SIZE})"

      - name: Upload safety backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.safety-backup.outputs.safety_filename }}
          path: ${{ steps.safety-backup.outputs.safety_filename }}
          retention-days: 7

      - name: Restore database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Parse DATABASE_URL
          PROTO="$(echo "$DATABASE_URL" | grep :// | sed -e 's,^\(.*://\).*,\1,g')"
          URL="${DATABASE_URL/$PROTO/}"
          USERPASS="$(echo "$URL" | cut -d@ -f1)"
          HOSTPORT_DB="$(echo "$URL" | cut -d@ -f2)"
          DB_USER="$(echo "$USERPASS" | cut -d: -f1)"
          DB_PASS="$(echo "$USERPASS" | cut -d: -f2)"
          DB_HOST="$(echo "$HOSTPORT_DB" | cut -d: -f1)"
          DB_PORT="$(echo "$HOSTPORT_DB" | cut -d: -f2 | cut -d/ -f1)"
          DB_NAME="$(echo "$HOSTPORT_DB" | cut -d/ -f2 | cut -d? -f1)"

          BACKUP_FILE="${{ github.event.inputs.backup_filename }}"
          echo "Restoring from: ${BACKUP_FILE}"

          gunzip -c "${BACKUP_FILE}" | PGPASSWORD="${DB_PASS}" psql \
            -h "${DB_HOST}" \
            -p "${DB_PORT}" \
            -U "${DB_USER}" \
            -d "${DB_NAME}" \
            --single-transaction \
            --set ON_ERROR_STOP=on

          echo "Database restore completed."

      - name: Run Drizzle migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        working-directory: apps/wiki-server
        run: pnpm db:migrate

      - name: Summary
        run: |
          echo "## Database Restore Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Backup restored:** ${{ github.event.inputs.backup_filename }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Source run:** ${{ github.event.inputs.backup_run_id }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Safety backup:** ${{ steps.safety-backup.outputs.safety_filename }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Migrations applied:** Yes (Drizzle)" >> "$GITHUB_STEP_SUMMARY"
