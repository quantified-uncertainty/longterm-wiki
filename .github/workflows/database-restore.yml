name: Database Restore

on:
  workflow_dispatch:
    inputs:
      backup_run_id:
        description: "GitHub Actions run ID containing the backup artifact"
        required: true
        type: string
      backup_filename:
        description: "Backup filename (e.g., longterm-wiki-scheduled-20240101_020000.sql.gz)"
        required: true
        type: string
      confirm:
        description: "Type RESTORE to confirm"
        required: true
        type: string

jobs:
  restore:
    name: Restore database
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'RESTORE'

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16

      - name: Install Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter wiki-server

      - name: Download backup artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.backup_filename }}
          run-id: ${{ github.event.inputs.backup_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse DATABASE_URL
        id: db
        uses: ./.github/actions/parse-database-url
        with:
          database_url: ${{ secrets.DATABASE_URL }}

      - name: Create pre-restore safety backup
        id: safety-backup
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SAFETY_FILENAME="longterm-wiki-pre-restore-${TIMESTAMP}.sql.gz"
          echo "safety_filename=${SAFETY_FILENAME}" >> "$GITHUB_OUTPUT"

          echo "Creating pre-restore safety backup: ${SAFETY_FILENAME}"
          PGPASSWORD="${{ steps.db.outputs.db-pass }}" pg_dump \
            -h "${{ steps.db.outputs.db-host }}" \
            -p "${{ steps.db.outputs.db-port }}" \
            -U "${{ steps.db.outputs.db-user }}" \
            -d "${{ steps.db.outputs.db-name }}" \
            --no-owner \
            --no-privileges \
            | gzip > "${SAFETY_FILENAME}"

          FILE_SIZE=$(du -h "${SAFETY_FILENAME}" | cut -f1)
          echo "Safety backup completed: ${SAFETY_FILENAME} (${FILE_SIZE})"

      - name: Upload safety backup
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.safety-backup.outputs.safety_filename }}
          path: ${{ steps.safety-backup.outputs.safety_filename }}
          retention-days: 7

      - name: Restore database
        run: |
          BACKUP_FILE="${{ github.event.inputs.backup_filename }}"
          echo "Restoring from: ${BACKUP_FILE}"

          gunzip -c "${BACKUP_FILE}" | PGPASSWORD="${{ steps.db.outputs.db-pass }}" psql \
            -h "${{ steps.db.outputs.db-host }}" \
            -p "${{ steps.db.outputs.db-port }}" \
            -U "${{ steps.db.outputs.db-user }}" \
            -d "${{ steps.db.outputs.db-name }}" \
            --single-transaction \
            --set ON_ERROR_STOP=on

          echo "Database restore completed."

      - name: Run Drizzle migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        working-directory: apps/wiki-server
        run: pnpm db:migrate

      - name: Summary
        run: |
          echo "## Database Restore Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Backup restored:** ${{ github.event.inputs.backup_filename }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Source run:** ${{ github.event.inputs.backup_run_id }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Safety backup:** ${{ steps.safety-backup.outputs.safety_filename }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Migrations applied:** Yes (Drizzle)" >> "$GITHUB_STEP_SUMMARY"
