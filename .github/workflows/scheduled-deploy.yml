name: Scheduled Production Deploy

# Daily fallback to ensure production stays fresh even in quiet periods
# (no PR merges for a day or more).
#
# Primary deploys are triggered by the CI workflow (deploy job) whenever
# a PR is merged to main and CI passes — that handles the common case.
# This workflow is the safety net.
#
# Setup (one-time):
#   1. Go to Vercel Dashboard → Project → Settings → Git → Deploy Hooks
#   2. Create a hook: Name "Scheduled Deploy", Branch "main"
#   3. Copy the generated URL (looks like https://api.vercel.com/v1/integrations/deploy/...)
#   4. Add it as a GitHub secret: Settings → Secrets → Actions → New secret
#      Name: VERCEL_DEPLOY_HOOK_URL
#      Value: <paste URL>

on:
  schedule:
    - cron: '0 4 * * *'    # Daily at 04:00 UTC (fallback only)
  workflow_dispatch:         # Allow manual trigger from GitHub Actions UI

jobs:
  trigger-production-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Trigger Vercel production deployment
        run: |
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" ]; then
            echo "::error::VERCEL_DEPLOY_HOOK_URL secret is not set."
            echo "See setup instructions in the workflow file comments."
            exit 1
          fi

          RESPONSE=$(curl -s -o /tmp/vercel_response.json -w "%{http_code}" \
            -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}")

          echo "HTTP status: $RESPONSE"
          echo "Response body:"
          cat /tmp/vercel_response.json

          if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ]; then
            echo "Production deployment triggered."
          else
            echo "::error::Vercel deploy hook returned HTTP $RESPONSE"
            exit 1
          fi

      - name: Log deploy trigger
        if: always()
        run: |
          echo "## Scheduled Production Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/vercel_response.json ]; then
            JOB_ID=$(cat /tmp/vercel_response.json | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")
            echo "- **Vercel job:** $JOB_ID" >> $GITHUB_STEP_SUMMARY
          fi
