name: Wiki Server — Health Monitor

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch:

# Prevent overlapping runs (avoids race conditions with issue create/close)
concurrency:
  group: server-health-monitor
  cancel-in-progress: false

jobs:
  health-check:
    name: Check wiki-server health
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check health endpoint (with retry)
        id: health
        env:
          LONGTERMWIKI_SERVER_URL: ${{ secrets.LONGTERMWIKI_SERVER_URL }}
        run: |
          if [ -z "$LONGTERMWIKI_SERVER_URL" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=LONGTERMWIKI_SERVER_URL secret is not set" >> "$GITHUB_OUTPUT"
            echo "response=" >> "$GITHUB_OUTPUT"
            echo "http_code=000" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Retry up to 3 times with 10s delay to avoid false positives
          # from transient network issues or brief pod restarts.
          MAX_ATTEMPTS=3
          DELAY=10
          HEALTHY=""
          LAST_HTTP_CODE=""
          LAST_ERROR=""
          LAST_RESPONSE=""

          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
              --max-time 10 "${LONGTERMWIKI_SERVER_URL}/health" 2>/dev/null) || HTTP_CODE="000"

            RESPONSE=$(cat /tmp/health_response.json 2>/dev/null || echo "")
            LAST_HTTP_CODE="$HTTP_CODE"
            LAST_RESPONSE="$RESPONSE"

            if [ "$HTTP_CODE" = "000" ]; then
              LAST_ERROR="Connection failed or timed out (no HTTP response)"
            elif [ "$HTTP_CODE" != "200" ]; then
              LAST_ERROR="HTTP $HTTP_CODE"
            else
              STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
              DB_STATUS=$(echo "$RESPONSE" | jq -r '.database // "unknown"')

              if [ "$STATUS" = "healthy" ] && [ "$DB_STATUS" = "ok" ]; then
                HEALTHY="true"
                break
              else
                LAST_ERROR="status=$STATUS, database=$DB_STATUS"
              fi
            fi

            echo "Health check attempt $i/$MAX_ATTEMPTS failed: $LAST_ERROR"
            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              sleep $DELAY
            fi
          done

          echo "http_code=$LAST_HTTP_CODE" >> "$GITHUB_OUTPUT"
          echo "response<<__HEALTH_EOF__" >> "$GITHUB_OUTPUT"
          echo "$LAST_RESPONSE" >> "$GITHUB_OUTPUT"
          echo "__HEALTH_EOF__" >> "$GITHUB_OUTPUT"

          if [ "$HEALTHY" = "true" ]; then
            echo "healthy=true" >> "$GITHUB_OUTPUT"
          else
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=$LAST_ERROR" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for existing open issue
        if: steps.health.outputs.healthy == 'false'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          echo "issue=${ISSUE}" >> "$GITHUB_OUTPUT"

      - name: Create or update issue
        if: steps.health.outputs.healthy == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEALTH_ERROR: ${{ steps.health.outputs.error }}
          HEALTH_HTTP_CODE: ${{ steps.health.outputs.http_code }}
          HEALTH_RESPONSE: ${{ steps.health.outputs.response }}
          EXISTING_ISSUE: ${{ steps.existing.outputs.issue }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          # Build the issue body with a quoted heredoc to prevent shell injection
          # from untrusted HEALTH_RESPONSE content. Variables are inserted via sed.
          cat > /tmp/issue_body.md <<'ISSUE_BODY'
          ## Wiki server health check failed

          | Field | Value |
          |-------|-------|
          | **Status** | :red_circle: Unhealthy |
          | **Detected at** | __TIMESTAMP__ |
          | **Error** | __HEALTH_ERROR__ |
          | **HTTP status** | __HEALTH_HTTP_CODE__ |

          ### Health endpoint response

          ```json
          __HEALTH_RESPONSE__
          ```

          ### Possible causes

          - **HTTP 503 / connection refused** — Pod is crashing or not running
          - **`database: "error"`** — Database connection or query failure (bad migration, permissions, DB down)
          - **`status: "degraded"`** — Server is running but some queries are failing
          - **Connection timeout** — DNS, ingress, or networking issue

          ### Useful commands

          ```bash
          # Pod status
          kubectl get pods -n longtermwiki

          # Current logs
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --tail=50

          # Previous crash logs (if pod restarted)
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --previous

          # Restart the deployment
          kubectl rollout restart deployment -n longtermwiki longterm-wiki-server-wiki-server
          ```

          ---
          *Created automatically by the [health monitor workflow](https://github.com/quantified-uncertainty/longterm-wiki/actions/workflows/server-health-monitor.yml). Will be closed automatically when the server recovers.*
          ISSUE_BODY

          # Strip leading whitespace from heredoc (YAML indentation)
          sed -i 's/^          //' /tmp/issue_body.md

          # Safely substitute values (escape sed special chars in values first)
          escape_sed() { printf '%s\n' "$1" | sed 's/[&/\]/\\&/g'; }
          sed -i "s|__TIMESTAMP__|$(escape_sed "$TIMESTAMP")|g" /tmp/issue_body.md
          sed -i "s|__HEALTH_ERROR__|$(escape_sed "$HEALTH_ERROR")|g" /tmp/issue_body.md
          sed -i "s|__HEALTH_HTTP_CODE__|$(escape_sed "$HEALTH_HTTP_CODE")|g" /tmp/issue_body.md
          sed -i "s|__HEALTH_RESPONSE__|$(escape_sed "$HEALTH_RESPONSE")|g" /tmp/issue_body.md

          if [ -n "$EXISTING_ISSUE" ]; then
            # Reopen and comment on existing issue instead of creating a new one
            gh issue reopen "$EXISTING_ISSUE" --repo "${{ github.repository }}" 2>/dev/null || true
            gh issue comment "$EXISTING_ISSUE" \
              --repo "${{ github.repository }}" \
              --body "Server is still unhealthy at ${TIMESTAMP}. Error: ${HEALTH_ERROR} (HTTP ${HEALTH_HTTP_CODE})"
          else
            # Ensure labels exist before creating issue
            gh label create "server-health" --repo "${{ github.repository }}" \
              --color "d73a4a" --description "Wiki server health monitoring" 2>/dev/null || true

            gh issue create \
              --repo "${{ github.repository }}" \
              --title "Wiki server is unhealthy (${HEALTH_ERROR})" \
              --label "server-health,bug" \
              --body-file /tmp/issue_body.md
          fi

      - name: Close resolved issue
        if: steps.health.outputs.healthy == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$ISSUE" ]; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            gh issue comment "$ISSUE" \
              --repo "${{ github.repository }}" \
              --body "Server is healthy again at ${TIMESTAMP}. Auto-closing."
            gh issue close "$ISSUE" \
              --repo "${{ github.repository }}"
          fi
