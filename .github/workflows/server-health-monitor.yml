name: Wiki Server — Health Monitor

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Check wiki-server health
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check health endpoint
        id: health
        env:
          LONGTERMWIKI_SERVER_URL: ${{ secrets.LONGTERMWIKI_SERVER_URL }}
        run: |
          if [ -z "$LONGTERMWIKI_SERVER_URL" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=LONGTERMWIKI_SERVER_URL secret is not set" >> "$GITHUB_OUTPUT"
            echo "response=" >> "$GITHUB_OUTPUT"
            echo "http_code=000" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
            --max-time 10 "${LONGTERMWIKI_SERVER_URL}/health" 2>/dev/null) || HTTP_CODE="000"

          echo "http_code=$HTTP_CODE" >> "$GITHUB_OUTPUT"

          if [ "$HTTP_CODE" = "000" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=Connection failed or timed out (no HTTP response)" >> "$GITHUB_OUTPUT"
            echo "response=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RESPONSE=$(cat /tmp/health_response.json 2>/dev/null || echo "")
          echo "response<<HEREDOC_EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "HEREDOC_EOF" >> "$GITHUB_OUTPUT"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=HTTP $HTTP_CODE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
          DB_STATUS=$(echo "$RESPONSE" | jq -r '.database // "unknown"')

          if [ "$STATUS" = "healthy" ] && [ "$DB_STATUS" = "ok" ]; then
            echo "healthy=true" >> "$GITHUB_OUTPUT"
          else
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=status=$STATUS, database=$DB_STATUS" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for existing open issue
        if: steps.health.outputs.healthy == 'false'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number,updatedAt \
            --jq '.[0] // empty')

          if [ -n "$ISSUE" ]; then
            echo "issue=$(echo "$ISSUE" | jq -r '.number')" >> "$GITHUB_OUTPUT"
            UPDATED=$(echo "$ISSUE" | jq -r '.updatedAt')
            UPDATED_TS=$(date -d "$UPDATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$UPDATED" +%s 2>/dev/null || echo "0")
            NOW_TS=$(date +%s)
            AGE=$(( NOW_TS - UPDATED_TS ))
            # Only comment if last update was more than 30 minutes ago
            if [ "$AGE" -gt 1800 ]; then
              echo "should_comment=true" >> "$GITHUB_OUTPUT"
            else
              echo "should_comment=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "issue=" >> "$GITHUB_OUTPUT"
            echo "should_comment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue
        if: steps.health.outputs.healthy == 'false' && steps.existing.outputs.issue == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEALTH_ERROR: ${{ steps.health.outputs.error }}
          HEALTH_HTTP_CODE: ${{ steps.health.outputs.http_code }}
          HEALTH_RESPONSE: ${{ steps.health.outputs.response }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          cat > /tmp/issue_body.md <<EOF
          ## Wiki server health check failed

          | Field | Value |
          |-------|-------|
          | **Status** | :red_circle: Unhealthy |
          | **Error** | ${HEALTH_ERROR} |
          | **HTTP status** | ${HEALTH_HTTP_CODE} |
          | **Detected at** | ${TIMESTAMP} |

          ### Health endpoint response

          \`\`\`json
          ${HEALTH_RESPONSE}
          \`\`\`

          ### Possible causes

          - **HTTP 503 / connection refused** — Pod is crashing or not running. Check \`kubectl get pods -n longtermwiki\` and \`kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --previous\`
          - **\`database: "error"\`** — Database connection or query failure. Could be a bad migration, permission issue, or DB cluster is down.
          - **\`status: "degraded"\`** — Server is running but some queries are failing. Check the server logs for SQL errors.
          - **Connection timeout** — DNS, ingress, or networking issue. Check \`kubectl get ingress -n longtermwiki\`.

          ### Useful commands

          \`\`\`bash
          # Pod status
          kubectl get pods -n longtermwiki

          # Current logs
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --tail=50

          # Previous crash logs
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --previous

          # Restart the deployment
          kubectl rollout restart deployment -n longtermwiki longterm-wiki-server-wiki-server
          \`\`\`

          ---
          *This issue was created automatically by the [health monitor workflow](https://github.com/quantified-uncertainty/longterm-wiki/actions/workflows/server-health-monitor.yml). It will be closed automatically when the server recovers. Comments are throttled to once per 30 minutes during prolonged outages.*
          EOF

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "Wiki server is unhealthy (${HEALTH_ERROR})" \
            --label "server-health,bug" \
            --body-file /tmp/issue_body.md

      - name: Comment on existing issue
        if: steps.health.outputs.healthy == 'false' && steps.existing.outputs.issue != '' && steps.existing.outputs.should_comment == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEALTH_ERROR: ${{ steps.health.outputs.error }}
          HEALTH_HTTP_CODE: ${{ steps.health.outputs.http_code }}
          HEALTH_RESPONSE: ${{ steps.health.outputs.response }}
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          cat > /tmp/comment_body.md <<EOF
          Still unhealthy at ${TIMESTAMP} — **${HEALTH_ERROR}** (HTTP ${HEALTH_HTTP_CODE})

          \`\`\`json
          ${HEALTH_RESPONSE}
          \`\`\`
          EOF

          gh issue comment "${{ steps.existing.outputs.issue }}" \
            --repo "${{ github.repository }}" \
            --body-file /tmp/comment_body.md

      - name: Close resolved issue
        if: steps.health.outputs.healthy == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEALTH_RESPONSE: ${{ steps.health.outputs.response }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$ISSUE" ]; then
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            cat > /tmp/close_body.md <<EOF
          Server is healthy again at ${TIMESTAMP}. Auto-closing.

          \`\`\`json
          ${HEALTH_RESPONSE}
          \`\`\`
          EOF

            gh issue comment "$ISSUE" \
              --repo "${{ github.repository }}" \
              --body-file /tmp/close_body.md
            gh issue close "$ISSUE" \
              --repo "${{ github.repository }}"
          fi
