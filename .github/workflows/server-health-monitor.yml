name: Wiki Server — Health Monitor

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Check wiki-server health
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check health endpoint
        id: health
        env:
          LONGTERMWIKI_SERVER_URL: ${{ secrets.LONGTERMWIKI_SERVER_URL }}
        run: |
          HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
            --max-time 10 "${LONGTERMWIKI_SERVER_URL}/health" 2>/dev/null) || HTTP_CODE="000"

          echo "http_code=$HTTP_CODE" >> "$GITHUB_OUTPUT"

          if [ "$HTTP_CODE" = "000" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=Connection failed or timed out (no HTTP response)" >> "$GITHUB_OUTPUT"
            echo "response=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RESPONSE=$(cat /tmp/health_response.json 2>/dev/null || echo "")
          echo "response<<HEREDOC_EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "HEREDOC_EOF" >> "$GITHUB_OUTPUT"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=HTTP $HTTP_CODE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')
          DB_STATUS=$(echo "$RESPONSE" | jq -r '.database // "unknown"')

          if [ "$STATUS" = "healthy" ] && [ "$DB_STATUS" = "ok" ]; then
            echo "healthy=true" >> "$GITHUB_OUTPUT"
          else
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "error=status=$STATUS, database=$DB_STATUS" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for existing open issue
        if: steps.health.outputs.healthy == 'false'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"

      - name: Create issue
        if: steps.health.outputs.healthy == 'false' && steps.existing.outputs.issue == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat <<'ISSUE_EOF' > /tmp/issue_body.md
          ## Wiki server health check failed

          | Field | Value |
          |-------|-------|
          | **Status** | :red_circle: Unhealthy |
          | **Error** | PLACEHOLDER_ERROR |
          | **HTTP status** | PLACEHOLDER_HTTP_CODE |
          | **Detected at** | PLACEHOLDER_TIMESTAMP |

          ### Health endpoint response

          ```json
          PLACEHOLDER_RESPONSE
          ```

          ### Possible causes

          - **HTTP 503 / connection refused** — Pod is crashing or not running. Check `kubectl get pods -n longtermwiki` and `kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --previous`
          - **`database: "error"`** — Database connection or query failure. Could be a bad migration, permission issue, or DB cluster is down.
          - **`status: "degraded"`** — Server is running but some queries are failing. Check the server logs for SQL errors.
          - **Connection timeout** — DNS, ingress, or networking issue. Check `kubectl get ingress -n longtermwiki`.

          ### Useful commands

          ```bash
          # Pod status
          kubectl get pods -n longtermwiki

          # Current logs
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --tail=50

          # Previous crash logs
          kubectl logs -n longtermwiki -l app=longterm-wiki-server-wiki-server --previous

          # Restart the deployment
          kubectl rollout restart deployment -n longtermwiki longterm-wiki-server-wiki-server
          ```

          ---
          *This issue was created automatically by the [health monitor workflow](https://github.com/quantified-uncertainty/longterm-wiki/actions/workflows/server-health-monitor.yml). It will be closed automatically when the server recovers.*
          ISSUE_EOF

          # Fill in placeholders (avoids issues with special characters in GH expressions)
          sed -i "s|PLACEHOLDER_ERROR|${{ steps.health.outputs.error }}|g" /tmp/issue_body.md
          sed -i "s|PLACEHOLDER_HTTP_CODE|${{ steps.health.outputs.http_code }}|g" /tmp/issue_body.md
          sed -i "s|PLACEHOLDER_TIMESTAMP|$(date -u '+%Y-%m-%d %H:%M:%S UTC')|g" /tmp/issue_body.md
          sed -i "s|PLACEHOLDER_RESPONSE|${{ steps.health.outputs.response }}|g" /tmp/issue_body.md

          gh issue create \
            --repo "${{ github.repository }}" \
            --title "Wiki server is unhealthy (${{ steps.health.outputs.error }})" \
            --label "server-health,bug" \
            --body-file /tmp/issue_body.md

      - name: Comment on existing issue
        if: steps.health.outputs.healthy == 'false' && steps.existing.outputs.issue != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ steps.existing.outputs.issue }}" \
            --repo "${{ github.repository }}" \
            --body "Still unhealthy at $(date -u '+%Y-%m-%d %H:%M:%S UTC') — **${{ steps.health.outputs.error }}** (HTTP ${{ steps.health.outputs.http_code }})
          \`\`\`json
          ${{ steps.health.outputs.response }}
          \`\`\`"

      - name: Close resolved issue
        if: steps.health.outputs.healthy == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "server-health" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$ISSUE" ]; then
            gh issue comment "$ISSUE" \
              --repo "${{ github.repository }}" \
              --body "Server is healthy again at $(date -u '+%Y-%m-%d %H:%M:%S UTC'). Auto-closing.
          \`\`\`json
          ${{ steps.health.outputs.response }}
          \`\`\`"
            gh issue close "$ISSUE" \
              --repo "${{ github.repository }}"
          fi
