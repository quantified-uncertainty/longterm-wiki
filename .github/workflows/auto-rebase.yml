name: Auto-Rebase PRs

# When main is updated, rebase all open PRs to surface conflicts early.
# PRs with no real conflicts get silently rebased; PRs with conflicts
# are left alone for the conflict-resolver workflow to handle.

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: auto-rebase
  cancel-in-progress: true # newer main state supersedes in-progress rebase

jobs:
  rebase-open-prs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebase open PRs onto main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # List open PR branches targeting main (skip drafts)
          prs=$(gh pr list --base main --state open --json number,headRefName,isDraft \
            --jq '.[] | select(.isDraft == false) | "\(.number) \(.headRefName)"')

          if [ -z "$prs" ]; then
            echo "No open PRs to rebase."
            exit 0
          fi

          failed=0

          # Use here-string to avoid subshell from pipe (errors propagate correctly)
          while read -r pr_number branch; do
            echo "::group::PR #${pr_number} (${branch})"

            # Validate branch name
            if ! echo "$branch" | grep -qE '^[a-zA-Z0-9._/-]+$'; then
              echo "::warning::PR #${pr_number} has invalid branch name — skipping."
              echo "::endgroup::"
              continue
            fi

            if ! git fetch origin -- "$branch" 2>/dev/null; then
              echo "::warning::PR #${pr_number} — could not fetch branch ${branch} (may be from a fork)."
              echo "::endgroup::"
              continue
            fi

            git checkout --detach origin/main 2>/dev/null
            git checkout -B "$branch" "origin/$branch"

            if git rebase origin/main; then
              # Check if rebase actually changed anything
              if [ "$(git rev-parse HEAD)" != "$(git rev-parse "origin/$branch")" ]; then
                push_output=""
                if push_output=$(git push origin -- "$branch" --force-with-lease 2>&1); then
                  echo "Rebased and pushed successfully."
                else
                  echo "::error::PR #${pr_number} — push failed: ${push_output}"
                  failed=$((failed + 1))
                fi
              else
                echo "Already up to date."
              fi
            else
              echo "::warning::PR #${pr_number} (${branch}) has merge conflicts — leaving for conflict resolver."
              git rebase --abort
            fi

            echo "::endgroup::"
          done <<< "$prs"

          if [ "$failed" -gt 0 ]; then
            echo "::error::${failed} PR(s) failed to push — they may need manual attention or will be retried on next run."
            exit 1
          fi
